"""Web app forms"""

from django import forms
from django.utils import timezone
from djng.forms import NgFormValidationMixin, NgModelForm, NgModelFormMixin
from djng.styling.bootstrap3.forms import Bootstrap3FormMixin

from certificate_engine.types import CertificateTypes
from x509_pki.forms import DistinguishedNameForm


class AddDistinguishedNameRootCAForm(
        NgModelFormMixin,
        NgFormValidationMixin,
        Bootstrap3FormMixin,
        NgModelForm,
        DistinguishedNameForm):
    scope_prefix = 'cert_data.dn'
    form_name = 'cert_form'

    def __init__(self, *args, **kwargs):
        super().__init__(*args, **kwargs)
        self.fields['subjectAltNames'].widget = forms.HiddenInput()
        self.fields['commonName'].help_text = \
            'The common name of your certification authority.' + \
            'This field is used to identify your CA in the chain'


class AddRootCAForm(
        NgModelFormMixin,
        NgFormValidationMixin,
        Bootstrap3FormMixin,
        NgModelForm):
    # TODO FIX THIS
    #    CertificateFormX509):
    scope_prefix = 'cert_data'
    form_name = 'cert_form'

    def clean_parent(self):
        return None

    def clean_type(self):
        return CertificateTypes.ROOT

    def __init__(self, *args, **kwargs):
        kwargs.update(auto_id=False, scope_prefix=self.scope_prefix)
        super().__init__(*args, **kwargs)
        self.fields.pop('dn')
        self.initial['parent'] = None
        self.initial['type'] = CertificateTypes.ROOT
        self.initial['expires_at'] = timezone.now(
        ) + timezone.timedelta(weeks=1040)

        self.fields['expires_at'].help_text = \
            'Expiration date of the root certificate, ' + \
            'typically 20 years. (format: yyyy-mm-dd)'

        self.fields['parent'].widget = forms.HiddenInput()
        self.fields['type'].widget = forms.HiddenInput()
        self.fields['passphrase_issuer'].widget = forms.HiddenInput()
        if 'scope_prefix' in kwargs:
            kwargs.pop('scope_prefix')
        if 'prefix' in kwargs:
            kwargs.pop('prefix')
        if 'initial' in kwargs and 'dn' in kwargs['initial']:
            initial = kwargs.pop('initial')
            kwargs['initial'] = initial['dn']
        self.dn = AddDistinguishedNameRootCAForm(
            scope_prefix='cert_data.dn', **kwargs)

    def is_valid(self):
        if not self.dn.is_valid():
            self.errors.update(self.dn.errors)
        return super().is_valid() and self.dn.is_valid()


class AddDistinguishedNameIntermediateCAForm(
        NgModelFormMixin,
        NgFormValidationMixin,
        Bootstrap3FormMixin,
        NgModelForm,
        DistinguishedNameForm):
    scope_prefix = 'cert_data.dn'
    form_name = 'cert_form'

    def __init__(self, *args, **kwargs):
        super().__init__(*args, **kwargs)

        self.fields['subjectAltNames'].widget = forms.HiddenInput()
        self.fields['commonName'].help_text = \
            'The common name of your intermediate certification authority. ' + \
            'This field is used to identify your intermediate CA in the chain'
        self.fields['countryName'].widget.attrs['disabled'] = 'disabled'
        self.fields['stateOrProvinceName'].widget.attrs['readonly'] = True
        self.fields['organizationName'].widget.attrs['readonly'] = True
        self.fields['localityName'].widget.attrs['readonly'] = True


class AddIntermediateCAForm(
        NgModelFormMixin,
        NgFormValidationMixin,
        Bootstrap3FormMixin,
        NgModelForm):
    # TODO FIX THIS
    #    CertificateFormX509):
    scope_prefix = 'cert_data'
    form_name = 'cert_form'

    def clean_parent(self):
        return None

    def clean_type(self):
        return CertificateTypes.INTERMEDIATE

    def __init__(self, *args, **kwargs):
        kwargs.update(auto_id=False, scope_prefix=self.scope_prefix)
        super().__init__(*args, **kwargs)
        self.fields.pop('dn')
        self.initial['type'] = CertificateTypes.INTERMEDIATE
        self.initial['expires_at'] = timezone.now(
        ) + timezone.timedelta(weeks=520)

        self.fields['expires_at'].help_text = \
            'Expiration date of the intermediate certificate, ' + \
            'typically 10 years. (format: yyyy-mm-dd)'

        self.fields['parent'].widget = forms.HiddenInput()
        self.fields['type'].widget = forms.HiddenInput()
        self.fields['crl_distribution_url'].widget = forms.HiddenInput()
        self.fields['ocsp_distribution_host'].widget = forms.HiddenInput()

        if 'scope_prefix' in kwargs:
            kwargs.pop('scope_prefix')
        if 'prefix' in kwargs:
            kwargs.pop('prefix')
        if 'initial' in kwargs and 'dn' in kwargs['initial']:
            initial = kwargs.pop('initial')
            kwargs['initial'] = initial['dn']
        self.dn = AddDistinguishedNameIntermediateCAForm(
            scope_prefix='cert_data.dn', **kwargs)

    def is_valid(self):
        if not self.dn.is_valid():
            self.errors.update(self.dn.errors)
        return super().is_valid() and self.dn.is_valid()


class AddDistinguishedNameServerCertificateForm(
        NgModelFormMixin,
        NgFormValidationMixin,
        Bootstrap3FormMixin,
        NgModelForm,
        DistinguishedNameForm):
    scope_prefix = 'cert_data.dn'
    form_name = 'cert_form'

    def __init__(self, *args, **kwargs):
        super().__init__(*args, **kwargs)
        self.fields['commonName'].help_text = 'The fully qualified domain name (FQDN) of your server. ' +\
            'This must match exactly what the url or wildcard or a name mismatch error will occur.'


class AddServerCertificateForm(
        NgModelFormMixin,
        NgFormValidationMixin,
        Bootstrap3FormMixin,
        NgModelForm):
    # TODO FIX THIS
    #    CertificateFormX509):
    scope_prefix = 'cert_data'
    form_name = 'cert_form'

    def clean_parent(self):
        return None

    def clean_type(self):
        return CertificateTypes.SERVER_CERT

    def __init__(self, *args, **kwargs):
        kwargs.update(auto_id=False, scope_prefix=self.scope_prefix)
        super().__init__(*args, **kwargs)
        self.fields.pop('dn')
        self.initial['type'] = CertificateTypes.SERVER_CERT
        self.initial['expires_at'] = timezone.now() + \
            timezone.timedelta(weeks=52)
        self.initial['passphrase_out'] = ""
        self.initial['passphrase_out_confirmation'] = ""
        self.fields['expires_at'].help_text = \
            'Expiration date of the server certificate, ' + \
            'typically 1 year. (format: yyyy-mm-dd)'

        self.fields['parent'].widget = forms.HiddenInput()
        self.fields['type'].widget = forms.HiddenInput()
        self.fields['crl_distribution_url'].widget = forms.HiddenInput()
        self.fields['ocsp_distribution_host'].widget = forms.HiddenInput()

        self.fields['passphrase_out'].required = False
        self.fields['passphrase_out_confirmation'].required = False

        if 'scope_prefix' in kwargs:
            kwargs.pop('scope_prefix')
        if 'prefix' in kwargs:
            kwargs.pop('prefix')
        if 'initial' in kwargs and 'dn' in kwargs['initial']:
            initial = kwargs.pop('initial')
            kwargs['initial'] = initial['dn']
        self.dn = AddDistinguishedNameServerCertificateForm(
            scope_prefix='cert_data.dn', **kwargs)

    def is_valid(self):
        if not self.dn.is_valid():
            self.errors.update(self.dn.errors)
        return super().is_valid() and self.dn.is_valid()


class AddDistinguishedNameClientCertificateForm(
        NgModelFormMixin,
        NgFormValidationMixin,
        Bootstrap3FormMixin,
        NgModelForm,
        DistinguishedNameForm):
    scope_prefix = 'cert_data.dn'
    form_name = 'cert_form'

    def __init__(self, *args, **kwargs):
        super().__init__(*args, **kwargs)
        self.fields[
            'commonName'].help_text = 'The account name of the client, for example username or email.'


class AddClientCertificateForm(
        NgModelFormMixin,
        NgFormValidationMixin,
        Bootstrap3FormMixin,
        NgModelForm):
    # TODO FIX THIS
    #    CertificateFormX509):
    scope_prefix = 'cert_data'
    form_name = 'cert_form'

    def clean_parent(self):
        return None

    def clean_type(self):
        return CertificateTypes.CLIENT_CERT

    def __init__(self, *args, **kwargs):
        kwargs.update(auto_id=False, scope_prefix=self.scope_prefix)
        super().__init__(*args, **kwargs)
        self.fields.pop('dn')
        self.initial['type'] = CertificateTypes.CLIENT_CERT
        self.initial['expires_at'] = timezone.now() + \
            timezone.timedelta(weeks=52)
        self.initial['passphrase_out'] = ""
        self.initial['passphrase_out_confirmation'] = ""
        self.fields['expires_at'].help_text = \
            'Expiration date of the client certificate, ' + \
            'typically 1 year. (format: yyyy-mm-dd)'

        self.fields['parent'].widget = forms.HiddenInput()
        self.fields['type'].widget = forms.HiddenInput()
        self.fields['crl_distribution_url'].widget = forms.HiddenInput()
        self.fields['ocsp_distribution_host'].widget = forms.HiddenInput()

        self.fields['passphrase_out'].required = False
        self.fields['passphrase_out_confirmation'].required = False

        if 'scope_prefix' in kwargs:
            kwargs.pop('scope_prefix')
        if 'prefix' in kwargs:
            kwargs.pop('prefix')
        if 'initial' in kwargs and 'dn' in kwargs['initial']:
            initial = kwargs.pop('initial')
            kwargs['initial'] = initial['dn']
        self.dn = AddDistinguishedNameClientCertificateForm(
            scope_prefix='cert_data.dn', **kwargs)

    def is_valid(self):
        if not self.dn.is_valid():
            self.errors.update(self.dn.errors)
        return super().is_valid() and self.dn.is_valid()


class CertificateRevokeForm(
        NgModelFormMixin,
        NgFormValidationMixin,
        Bootstrap3FormMixin,
        NgModelForm):
    # TODO FIX THIS
    #    CertificateFormX509):
    scope_prefix = 'cert_data'
    form_name = 'cert_form'

    def clean_parent(self):
        return None

    def __init__(self, *args, **kwargs):
        kwargs.update(auto_id=False, scope_prefix=self.scope_prefix)
        super().__init__(*args, **kwargs)


class CertificateCRLForm(
        NgModelFormMixin,
        NgFormValidationMixin,
        Bootstrap3FormMixin,
        NgModelForm):
    # TODO FIX THIS
    #    CertificateFormX509):
    scope_prefix = 'cert_data'
    form_name = 'cert_form'

    def clean_parent(self):
        return None

    def __init__(self, *args, **kwargs):
        kwargs.update(auto_id=False, scope_prefix=self.scope_prefix)
        super().__init__(*args, **kwargs)



from django.forms import ModelForm

"""Certificate create forms"""

from django import forms
from django.contrib.auth import password_validation
from django.utils import timezone




class DistinguishedNameForm(forms.ModelForm):

    def clean(self):
        """ This is the form's clean method, not a particular field's clean method """

        pk = self.instance.pk
        if pk is not None:
            raise forms.ValidationError(
                'Not allowed to update an existing certificate!')

    class Meta:
        model = DistinguishedName
        fields = (
            'commonName',
            'countryName',
            'stateOrProvinceName',
            'localityName',
            'organizationName',
            'organizationalUnitName',
            'emailAddress',
            'subjectAltNames')


class CertificateForm(forms.ModelForm):
    error_messages = {
        'password_mismatch': "The two passphrase fields didn't match."
    }

    passphrase_in = forms.CharField(
        label="Passphrase in",
        initial="",
        widget=forms.PasswordInput,
        strip=False,
        #        help_text=password_validation.password_validators_help_text_html(),
        help_text="The passphrase for unlocking your signing key.",
    )
    passphrase_out = forms.CharField(
        label="New passphrase",
        initial="",
        widget=forms.PasswordInput,
        strip=False,
        #        help_text=password_validation.password_validators_help_text_html(),
        help_text="Passphrase for protecting the key of your new certificate.",
    )
    passphrase_out_confirmation = forms.CharField(
        label="New passphrase confirmation",
        initial="",
        strip=False,
        widget=forms.PasswordInput,
        help_text="Enter the same passphrase as before, for verification.",
    )

    def validate(self, data):
        if data['passphrase_out1'] != data['passphrase_out_confirmation']:
            raise forms.ValidationError(
                "The two passphrase fields didn't match.")
        return data

    def clean_passphrase_in(self, passphrase_in):
        if passphrase_in:
            if not self.cleaned_data.get('parent'):
                raise forms.ValidationError(
                    "You should provide a parent certificate if you provide a passphrase in")
            parent = Certificate.objects.get(
                pk=self.cleaned_data.get('parent'))
            if not parent.is_passphrase_valid():
                raise forms.ValidationError(
                    "Passphrase incorrect. Not allowed to sign your certificate")
            return passphrase_in
        return None

    def clean_passphrase_out(self):
        passphrase_out = self.cleaned_data.get("passphrase_out")
        password_validation.validate_password(passphrase_out, self.instance)
        return passphrase_out

    def clean_passphrase_out_confirmation(self):
        passphrase_out = self.cleaned_data.get("passphrase_out")
        passphrase_out_confirmation = self.cleaned_data.get(
            "passphrase_out_confirmation")
        if passphrase_out and passphrase_out_confirmation and passphrase_out != passphrase_out_confirmation:
            raise forms.ValidationError(
                self.error_messages['password_mismatch'],
                code='password_mismatch',
            )
        password_validation.validate_password(
            passphrase_out_confirmation, self.instance)
        return passphrase_out_confirmation

    def clean(self):
        """ This is the form's clean method, not a particular field's clean method """
        cleaned_data = self.cleaned_data

        pk = self.instance.pk
        if pk is not None:
            raise forms.ValidationError(
                'Not allowed to update an existing certificate!')

        shortname = cleaned_data.get("shortname")
        cert_type = cleaned_data.get("type")
        dn = cleaned_data.get("dn")

        if Certificate.objects.filter(
                shortname=shortname,
                type=cert_type,
                revoked_uuid='00000000000000000000000000000001').count() > 0:
            raise forms.ValidationError(
                "Shortname (" +
                shortname +
                ") for " +
                dict(
                    Certificate.TYPES)[cert_type] +
                " already exists.")

        if Certificate.objects.filter(
                dn=dn,
                type=cert_type,
                revoked_uuid='00000000000000000000000000000001').count() > 0:
            raise forms.ValidationError(
                "DN (" +
                str(dn) +
                ") for " +
                dict(
                    Certificate.TYPES)[cert_type] +
                " already used.")

        parent = cleaned_data.get("parent")
        if cert_type == CertificateTypes.ROOT and parent:  # check_if_root_has_no_parent
            raise forms.ValidationError(
                'Not allowed to have a parent certificate for a ROOT CA certificate')

        if cert_type is not CertificateTypes.ROOT and not parent:  # check_if_root_has_no_parent
            raise forms.ValidationError(
                'Non ROOT certificate should have a parent certificate')

        if cert_type is CertificateTypes.SERVER_CERT and not (
                parent.type is CertificateTypes.INTERMEDIATE):  # check_if_non_root_certificate_has_parent
            raise forms.ValidationError(
                'Server certificate can only be generated for intermediate CA parent')

        if cert_type is CertificateTypes.CLIENT_CERT and not (
                parent.type is CertificateTypes.INTERMEDIATE):  # check_if_non_root_certificate_has_parent
            raise forms.ValidationError(
                'Client certificate can only be generated for intermediate CA parent')

        if cert_type is CertificateTypes.SERVER_CERT or cert_type is CertificateTypes.CLIENT_CERT:
            if Certificate.objects.filter(
                    dn=dn,
                    parent=parent,
                    type=CertificateTypes.INTERMEDIATE).count() > 0:
                raise forms.ValidationError(
                    "DN (" +
                    str(dn) +
                    ") for " +
                    dict(
                        Certificate.TYPES)[cert_type] +
                    "-Certificate already used as intermediate CA.")

        if cert_type is CertificateTypes.INTERMEDIATE and parent.type is CertificateTypes.ROOT:
            if dn.countryName != parent.dn.countryName:
                raise forms.ValidationError(
                    'Country name of Intermediate CA and Root CA should match (policy strict)')
            if dn.stateOrProvinceName != parent.dn.stateOrProvinceName:
                raise forms.ValidationError(
                    'State Or Province Name of Intermediate CA and Root CA should match (policy strict)')
            if dn.organizationName != parent.dn.organizationName:
                raise forms.ValidationError(
                    'Organization Name of Intermediate CA and Root CA should match (policy strict)')

        if cert_type is CertificateTypes.INTERMEDIATE and parent.crl_distribution_url:
            cleaned_data['crl_distribution_url'] = parent.crl_distribution_url

        if cleaned_data.get('expires_at'):
            now = timezone.now().date()
            expires_at = cleaned_data.get("expires_at")

            days_valid = int((expires_at - now).days)
            if parent and days_valid > parent.days_valid:
                raise forms.ValidationError(
                    'Child Certificate expiration data should be before parent expiration date')

        return cleaned_data

    class Meta:
        model = Certificate
        fields = (
            'shortname',
            'name',
            'parent',
            'type',
            'dn',
            'expires_at',
            'crl_distribution_url',
            'ocsp_distribution_host')


class CertificateRevokeForm(forms.ModelForm):

    passphrase_in = forms.CharField(
        label="Passphrase in",
        initial="",
        widget=forms.PasswordInput,
        strip=False,
        #        help_text=password_validation.password_validators_help_text_html(),
        help_text="The passphrase for unlocking your signing key.",
    )

    def clean_passphrase_in(self, passphrase_in):
        if passphrase_in:
            if not self.cleaned_data.get('parent'):
                raise forms.ValidationError(
                    "You should provide a parent certificate if you provide a passphrase in")
            parent = Certificate.objects.get(
                pk=self.cleaned_data.get('parent'))
            if not parent.is_passphrase_valid():
                raise forms.ValidationError(
                    "Passphrase incorrect. Not allowed to sign your certificate")
            return passphrase_in
        return None

    class Meta:
        model = Certificate
        fields = ()


class CertificateCRLForm(forms.ModelForm):

    passphrase_in = forms.CharField(
        label="Passphrase in",
        initial="",
        widget=forms.PasswordInput,
        strip=False,
        #        help_text=password_validation.password_validators_help_text_html(),
        help_text="The passphrase for unlocking your signing key.",
    )

    def clean_passphrase_in(self, passphrase_in):
        if passphrase_in:
            if not self.cleaned_data.get('parent'):
                raise forms.ValidationError(
                    "You should provide a parent certificate if you provide a passphrase in")
            parent = Certificate.objects.get(
                pk=self.cleaned_data.get('parent'))
            if not parent.is_passphrase_valid():
                raise forms.ValidationError(
                    "Passphrase incorrect. Not allowed to sign your certificate")
            return passphrase_in
        return None

    class Meta:
        model = Certificate
        fields = ()

class AddRootCAForm(ModelForm, CertificateForm):
    scope_prefix = 'cert_data'
    form_name = 'cert_form'

    def clean_parent(self):
        return None


    def __init__(self, *args, **kwargs):
        kwargs.update(auto_id=False, scope_prefix=self.scope_prefix)
        super().__init__(*args, **kwargs)
        self.fields.pop('dn')
        self.initial['parent'] = None
        self.initial['type'] = CertificateTypes.ROOT
        self.initial['expires_at'] = timezone.now(
        ) + timezone.timedelta(weeks=1040)

        self.fields['expires_at'].help_text = \
            'Expiration date of the root certificate, ' + \
            'typically 20 years. (format: yyyy-mm-dd)'

        self.fields['parent'].widget = forms.HiddenInput()
        self.fields['type'].widget = forms.HiddenInput()
        self.fields['passphrase_issuer'].widget = forms.HiddenInput()
        if 'scope_prefix' in kwargs:
            kwargs.pop('scope_prefix')
        if 'prefix' in kwargs:
            kwargs.pop('prefix')
        if 'initial' in kwargs and 'dn' in kwargs['initial']:
            initial = kwargs.pop('initial')
            kwargs['initial'] = initial['dn']
        self.dn = AddDistinguishedNameRootCAForm(
            scope_prefix='cert_data.dn', **kwargs)

